<!DOCTYPE html>
<html lang="en">

<!-- æœ¬é¡¹ç›®æœ€å¤§çš„å‘ï¼šctx.translateæ˜¯å¯å åŠ çš„ -->
<!-- è™½ç„¶HTMLjsä¸èƒ½ä¿®æ”¹ã€ä¿å­˜æ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘å¯ä»¥æŠŠä¿®æ”¹åçš„æ•°æ®å­˜å…¥img.srcä¸­ï¼Œç„¶åå°±èƒ½æ›´æ–°æ•°æ®å¹¶ä¸€ç›´ä¿æœ‰äº†é¸­ -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>ğŸ‘‹ Glyph Genius</title>
    <link href="/home.css" rel="stylesheet" type="text/css" />
    <!-- ttfæ–‡ä»¶åŠç”Ÿæˆçš„pngå›¾ç‰‡å­˜æ”¾åœ¨canvasScroll/ttf/æ–‡ä»¶å¤¹ä¸‹ -->
    <style>
        @font-face {
            font-family: ç”²éª¨æ–‡;
            src: url(./ttf/fangzheng-jiaguwen.TTF);
        }

        @font-face {
            font-family: é‡‘æ–‡å¤§ç¯†;
            src: url(./ttf/fangzheng-jinwendazhuan.TTF);
        }

        @font-face {
            font-family: éš¶ä¹¦;
            src: url(./ttf/fangzheng-liqibeilishu.TTF);
        }

        @font-face {
            font-family: å°ç¯†;
            src: url(./ttf/fangzheng-xiaozhuan.TTF);
        }
    </style>
</head>

<body>
    <div id="image"></div>
    <div id="gif"></div>
    <div id="overlay"></div>

    <span id="backWriteCSS">
        <img src="./static/icon/rewrite.svg" class="backWriteImg" onclick="backWrite()" />
        <span class="backWriteP">Rewrite</span>
    </span>
    <span id="reRenderCSS">
        <img src="./static/icon/regenerate.svg" class="reRenderImg" onclick="reRender()" />
        <span class="reRenderP">Regenerate</span>
    </span>
    <span id="backInputCSS">
        <img src="./static/icon/reinput_label.svg" class="backInputImg" onclick="backInput()" />
        <span class="backInputP">Reinput Prompt</span>
    </span>
    <span id="returnHomeCSS">
        <img src="./static/icon/home.svg" class="returnHomeImg" onclick="returnHome()" />
        <span class="returnHomeP">Home</span>
    </span>
    <span id="returnPreviousCSS">
        <img src="./static/icon/return_previous.svg" class="returnPreviousImg" onclick="returnPrevious()" />
        <span class="returnPreviousP">Back</span>
    </span>

    <canvas width="1600" height="1200" class="myCanvas" id="canvas"></canvas>
    <button id="clearbtn" class="bbtn" onclick="clearDraw()">Clear</button>
    <button id="selectbtn" class="bbtn" onclick="slectedOver()">Select Over</button>
    <button id="dwnbtn" class="bbtn" onclick="download()">Download</button>

    <!-- éšè—çš„è¾“å…¥æ¡†ï¼Œç­‰å¾…æ˜¾ç¤º -->
    <div id="container">
        <input class="inputRenderLabelBar" type="text" placeholder="e.g.[ä¸] - fluttering ribbons" />
        <button alt="" class="inputRenderLabelBtn" onclick="hideInput()">Do the Magic!</button>
    </div>
    
    <!-- æ˜¾ç¤ºæ±‰å­—ä¿¡æ¯ -->
    <div class="wrap">
        <div class="word-info">
            <div class="word-font" id="word-font"></div>
            <div class="word-bj" id="spell">
                Pronunciation:
            </div>
            <div class="word-bj" id="jiegou">
                Composition: 
            </div>
            <div class="word-hy" id="en_hanyi">
                Modern Meaningï¼š1ï¼šå›½éƒ½ï¼›é¦–éƒ½ã€‚2ï¼šåŒ—äº¬çš„ç®€ç§°ã€‚3ï¼šå§“
            </div>
            <div class="word-swjz" id="description">
                Explanation in "Shuowen Jiezi"ï¼šäººæ‰€çˆ²çµ•é«˜ä¸˜ä¹Ÿã€‚ä»é«˜çœï¼Œä¸¨ è±¡é«˜å½¢ã€‚å‡¡äº¬ä¹‹å±¬çš†ä»äº¬ã€‚ èˆ‰å¿åˆ‡ ã€‚
            </div>
        </div>
    </div>

    <!-- äºŒç»´ç å±•ä½ -->
    <div id="qrcode"></div>

    <!-- éšè—çš„åŠ è½½å¼¹çª—ï¼Œç­‰å¾…æ˜¾ç¤º -->
    <div id="modal" class="modal hidden">
        <p>We'll generate 6 results at once, please wait...</p>
        <p>Finished (<span id="count">0</span> / 6)</p>
        <p>After at least one image is finished, you can click to skip the rest process.</p>
        <button id="cancel" class="cancelbtn">skip</button>
    </div>

</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="./static/js/qrcode.js"></script>

<!-- æ¬¢è¿é¡µéƒ¨åˆ† -->
<script>
    var phase = 0;
    var canvasW = 1200;
    var canvasH = 600;

    //æ£€æŸ¥cookie
    var userCookie = checkUserIdCookie();

    //è®¾ç½®axiosè¯·æ±‚å…¬å…±å¤´
    axios.defaults.baseURL = '****://****'
    // axios.defaults.baseURL = 'http://127.0.0.1:9090'

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ“ä½œ
    window.onload = function () {
        phase = 0
        //å±•ç¤ºå†›ç«
        showWelcomeElement()
        document.body.addEventListener("click", showGif);
    };

    //ç”Ÿæˆéšæœºç”¨æˆ·ID
    function generateUserId() {
        return Math.random().toString(36).substring(2, 15);
    }

    //è®¾ç½®cookie
    function setCookie(name, value, days) {
        var expires = "", path = "; path=/", site = "; SameSite=None", secure = "; Secure";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + path + site + secure;
    }

    //è·å–cookie
    function getCookie(name) {
        var nameEQ = name + "=";
        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; ++i) {
            var cookie = cookies[i];
            while (cookie.charAt(0) === ' ')
                cookie = cookie.substring(1, cookie.length);
            if (cookie.split('=')[0] === name)
                return cookie.substring(nameEQ.length, cookie.length);
        }
        return "";
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰cookieï¼Œè‹¥æ— åˆ™æ–°å»ºä¸€ä¸ª
    function checkUserIdCookie() {
        var userId = getCookie("userId");
        if (userId === "") {
            userId = generateUserId();
            setCookie("userId", userId, 30);
        }
        return userId;
    }



    // æ˜¾ç¤ºGIF
    function showGif() {
        var gifDiv = document.getElementById("gif");
        var gifImg = document.createElement("img");
        gifImg.src = "./static/welcome.gif";
        gifImg.alt = "GIF animation";
        gifImg.style.width = "100%";
        gifImg.style.height = "100%";
        gifDiv.innerHTML = "";
        gifDiv.appendChild(gifImg);
        gifDiv.style.display = "block";

        //æ›´æ–°ç”»å¸ƒé•¿å®½ä¸ºé“ºæ»¡å±å¹•
        // è·å–å½“å‰å±å¹•å®½é«˜
        var screenWidth = window.innerWidth;
        var screenHeight = window.innerHeight;

        // è·å–canvaså…ƒç´ 
        var canvas = document.getElementById("canvas");
        // æ›´æ–°canvaså…ƒç´ çš„å®½é«˜
        canvas.width = screenWidth;
        canvas.height = screenHeight;

        const canvas_content = canvas.getBoundingClientRect()//è·å–ç”»å¸ƒçš„å¤§å°
        canvasW = canvas_content.width
        canvasH = canvas_content.height
        console.log("è·å– canvasWã€canvasHï¼š" + canvasW + "ã€" + canvasH)
        canvasH_W = canvasH / canvasW
        // åœæ­¢GIFæ’­æ”¾
        setTimeout(function () {
            coverWelcomeElement()
            console.log("æ‰§è¡Œå®Œæ¯•åè‡ªåŠ¨åˆ é™¤è‡ªå·±")
            //é¿å…åé¢çš„phaseä¸­ä¼šçªç„¶æ¥ä¸€ä¸ªå¼€å±é¡µï¼Œæˆ–è€…æœ€åä¸€é¡µç‚¹å‡»â€œé¦–é¡µâ€å›æ¥æ—¶è‡ªåŠ¨å±•ç¤ºåŠ¨ç”»
            document.body.removeEventListener("click", showGif)
            console.log("æ‰“å°ä¸€ä¸‹translateçš„å·¦æ ‡ç°åœ¨æ˜¯ä»€ä¹ˆ", PO)
            writeOnload()

        }, 4500); // 4.5ç§’ååœæ­¢æ’­æ”¾
    }

    function showWelcomeElement() {
        console.log("è®¾ç½®å…¨å±å±…ä¸­æ¬¢è¿é¡µå›¾ç‰‡")
        var imageDiv = document.getElementById("image");
        imageDiv.style.backgroundImage = "url('./static/welcome.png')";
        imageDiv.style.display = "block";
    }

    function coverWelcomeElement() {
        var imageDiv = document.getElementById("image");
        imageDiv.style.display = "none";
        var gifDiv = document.getElementById("gif");
        gifDiv.style.display = "none"
    }

    //æ£€æŸ¥phaseä»¥è®¾ç½®canvasèƒŒæ™¯
    function checkPhase() {
        switch (phase) {
            case 1:
                canvas.style.backgroundImage = 'url(' + "'./static/background/01-write-en.png'" + ')';
                var clearbtn = document.getElementById('clearbtn');
                clearbtn.style.right = canvasW / 10 + 'px';
                clearbtn.style.bottom = canvasH / 13 + 'px';
                clearbtn.style.width = canvasW / 11 + 'px';
                clearbtn.style.height = canvasH / 12 + "px";
                clearbtn.style.display = "block";
                break;
            case 2:
                //ä¸æ˜¾ç¤ºâ€œæ¸…é™¤â€æŒ‰é’®
                var clearbtn = document.getElementById('clearbtn');
                clearbtn.style.display = "none";
                //æ˜¾ç¤ºâ€œé€‰æ‹©å®Œæ¯•â€æŒ‰é’®
                var selectbtn = document.getElementById('selectbtn');
                selectbtn.style.right = canvasW / 10 + 'px';
                selectbtn.style.bottom = canvasH / 13 + 'px';
                selectbtn.style.width = canvasW / 8 + 'px';
                selectbtn.style.height = canvasH / 12 + "px";
                selectbtn.style.display = "block";
                //æ˜¾ç¤ºâ€œé‡å†™â€æŒ‰é’®
                var backWriteCSS = document.getElementById('backWriteCSS')
                backWriteCSS.style.display = "block"
                break;
            case 99:
                canvas.style.backgroundImage = 'url(' + "'./static/background/02-show-en.png'" + ')';
                //ä¸æ˜¾ç¤ºâ€œé‡å†™â€æŒ‰é’®
                var backWriteCSS = document.getElementById('backWriteCSS')
                backWriteCSS.style.display = "none"
                //ä¸æ˜¾ç¤ºâ€œé€‰æ‹©å®Œæ¯•â€æŒ‰é’®
                var selectbtn = document.getElementById('selectbtn');
                // selectbtn.style.display = "none";
                break;
            case 3:
                canvas.style.backgroundImage = 'url(' + "'./static/background/03-input-en.png'" + ')';
                //ä¸æ˜¾ç¤ºâ€œé‡å†™â€æŒ‰é’®
                var backWriteCSS = document.getElementById('backWriteCSS')
                backWriteCSS.style.display = "none"
                //ä¸æ˜¾ç¤ºâ€œé€‰æ‹©å®Œæ¯•â€æŒ‰é’®
                var selectbtn = document.getElementById('selectbtn');
                selectbtn.style.display = "none";
                break;
            case 6:
                canvas.style.backgroundImage = 'url(' + "'./static/background/06-result-en.png'" + ')';
                //è·³è½¬åè¦å°†æ¸…ç©ºè¾“å…¥æ¡†çš„å†…å®¹ï¼ŒæŠŠå®ƒéšè—èµ·æ¥
                const inputBox = document.getElementById("container");
                inputBox.style.display = "none"
                inputBox.querySelector("input").value = ""
                //ä¸æ˜¾ç¤ºâ€œä¸‹è½½â€æŒ‰é’®
                var dwnbtn = document.getElementById('dwnbtn');
                dwnbtn.style.display = "none";
                //æ˜¾ç¤ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
                var reRenderCSS = document.getElementById('reRenderCSS')
                reRenderCSS.style.display = "block";
                //æ˜¾ç¤ºâ€œé‡æ–°è¾“å…¥æ ‡ç­¾â€æŒ‰é’®
                var backInputCSS = document.getElementById('backInputCSS')
                backInputCSS.style.left = "220px";
                backInputCSS.style.display = "block";
                //ä¸æ˜¾ç¤ºâ€œè¿”å›â€æŒ‰é’®
                var returnPreviousCSS = document.getElementById('returnPreviousCSS')
                returnPreviousCSS.style.display = "none";
                break;
            case 4:
                canvas.style.backgroundImage = 'url(' + "'./static/background/07-recombine-en.png'" + ')';
                //ä¸æ˜¾ç¤ºåŠ è½½ä¸­çš„modal
                var modal = document.getElementById("modal");
                modal.classList.add("hidden");
                //ä¸æ˜¾ç¤ºè’™ç‰ˆ
                var overlay = document.getElementById("overlay");
                overlay.style.backgroundColor = "rgba(0, 0, 0, 0)"
                overlay.style.display = "none";
                //ä¸æ˜¾ç¤ºâ€œé‡æ–°è¾“å…¥æ ‡ç­¾â€æŒ‰é’®
                var backInputCSS = document.getElementById('backInputCSS')
                backInputCSS.style.display = "none";
                //æ˜¾ç¤ºâ€œä¸‹è½½â€æŒ‰é’®
                var dwnbtn = document.getElementById('dwnbtn');
                dwnbtn.style.right = canvasW / 10 + 'px';
                dwnbtn.style.bottom = canvasH / 13 + 'px';
                dwnbtn.style.width = canvasW / 11 + 'px';
                dwnbtn.style.height = canvasH / 12 + "px";
                dwnbtn.style.display = "block";
                //æ˜¾ç¤ºâ€œè¿”å›â€æŒ‰é’®
                var returnPreviousCSS = document.getElementById('returnPreviousCSS')
                returnPreviousCSS.style.display = "block";
                //æ–°æ·»åŠ 
                //ä¸æ˜¾ç¤ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
                var reRenderCSS = document.getElementById('reRenderCSS')
                reRenderCSS.style.display = "none";
                break;
            case 5:
                canvas.style.backgroundImage = 'url(' + "'./static/background/08-save-en.png'" + ')';
                //ä¸æ˜¾ç¤ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
                var reRenderCSS = document.getElementById('reRenderCSS')
                reRenderCSS.style.display = "none";
                //ä¸æ˜¾ç¤ºâ€œä¸‹è½½â€æŒ‰é’®
                var dwnbtn = document.getElementById('dwnbtn');
                dwnbtn.style.display = "none";
                //ä¸æ˜¾ç¤ºâ€œè¿”å›â€æŒ‰é’®
                var returnPreviousCSS = document.getElementById('returnPreviousCSS')
                returnPreviousCSS.style.display = "none";
                break;
        }
    }
</script>


<!-- æ‰‹å†™éƒ¨åˆ† -->
<script>
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var isDraw = false; //å®šä¹‰å˜é‡æ§åˆ¶ç”»ç¬”æ˜¯å¦å¯ç”¨
    var movePos;         //å®šä¹‰å˜é‡å­˜æ”¾åˆå§‹ç”»ç¬”å¼€å§‹ä½ç½®
    var drawWidth = 10
    var drawColor = 'white'
    var lastButtonDownTime
    var timeoutId = null;

    var PO = { x: 0, y: 0 };

    //æ¸…é™¤
    function clearDraw() {
        console.log("ä¸€å¾‹æ¸…é™¤")
        ctx.clearRect(-canvas.width, -canvas.height, canvas.width * 2, canvas.height * 2);
    }

    function writeOnload() {
        phase = 1
        console.log("è¿›å…¥ç¬¬ä¸€é˜¶æ®µï¼Œæ‰‹å†™")
        checkPhase()

        PO = { x: 0, y: 0 };
        //æ¸…ç©ºç”»å¸ƒ
        clearDraw()

        //æ¸…ç©ºé€‰æ‹©ç¬”ç”»
        chosenStrokes = []

        //è§¦æ‘¸æ‘¸ä¸‹
        canvas.ontouchstart = function (e) {
            isDraw = true;
            movePos = getPos(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            // console.log("è§¦æ‘¸çš„ä½ç½®",movePos)
            touchDrawing(e);
        }
        //è§¦æ‘¸ç§»åŠ¨
        canvas.ontouchmove = function (e) {
            console.log("è§¦æ‘¸ä¸‹æ¥æ˜¯åœ¨ç§»åŠ¨")
            touchDrawing(e);
        }
        //åœæ­¢è§¦æ‘¸
        canvas.ontouchend = function (e) {
            if (phase == 1) {
                isDraw = false;
                if (timeoutId === null) {
                    console.log('2ç§’é’Ÿæ²¡æœ‰ç‚¹å‡»ï¼Œæ‰§è¡ŒwriteOverå‡½æ•°');
                    timeoutId = setTimeout(writeOver, 2500);
                } else {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(writeOver, 2500);
                }
            }
        }
        //æ‘¸å‡ºåŒºåŸŸ
        canvas.ontouchcancel = function (e) {
            isDraw = false;
        }
        //é¼ æ ‡ç‚¹ä¸‹
        canvas.onmousedown = function (e) {
            // é˜»æ­¢é»˜è®¤äº‹ä»¶
            e.preventDefault();
            // console.log("é¼ æ ‡æŒ‰ä¸‹")
            isDraw = true;
            movePos = getPos(e.clientX, e.clientY);
            ClickDrawing(e);
        }
        //é¼ æ ‡ç§»åŠ¨
        canvas.onmousemove = function (e) {
            // é˜»æ­¢é»˜è®¤äº‹ä»¶
            e.preventDefault();
            // console.log("é¼ æ ‡ç§»åŠ¨isDraw",isDraw)
            ClickDrawing(e);
        }
        //é¼ æ ‡æ¾å¼€
        canvas.onmouseup = function (e) {
            // é˜»æ­¢é»˜è®¤äº‹ä»¶
            e.preventDefault();
            // console.log("é¼ æ ‡æ¾å¼€isDraw0",isDraw)
            isDraw = false;
            if (phase == 1) {
                if (timeoutId === null) {
                    timeoutId = setTimeout(writeOver, 2000);
                } else {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(writeOver, 2000);
                }
            }
        }
        //é¼ æ ‡ç¦»å¼€
        canvas.onmouseout = function (e) {
            // console.log("é¼ æ ‡ç¦»å¼€isDraw",isDraw)
            isDraw = false;
        }

    }

    //è·å–é¼ æ ‡ç›¸å¯¹ä¸canvasä½ç½®
    function getPos(x, y) {
        var box = canvas.getBoundingClientRect();
        return { x: x - box.left, y: y - box.top };
    };

    //è§¦æ‘¸ç”»ç¬”
    function touchDrawing(touchEvent) {
        if (isDraw) {
            var position = getPos(touchEvent.changedTouches[0].clientX, touchEvent.changedTouches[0].clientY);
            ctx.fillStyle = drawColor; // è®¾ç½®å¡«å……é¢œè‰²ä¸ºç™½è‰²
            ctx.beginPath()
            ctx.arc(position.x, position.y, drawWidth, 0, 2 * Math.PI); // åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶å°åœ†å½¢è½¨è¿¹
            ctx.fill()
            interpolateAndDraw(movePos.x, movePos.y, position.x, position.y)
            movePos = position;
            ctx.restore();
        }
    }

    //é¼ æ ‡ç”»ç¬”
    function ClickDrawing(clickEvent) {
        if (isDraw) {
            var position = getPos(clickEvent.clientX, clickEvent.clientY)
            ctx.fillStyle = drawColor; // è®¾ç½®å¡«å……é¢œè‰²ä¸ºç™½è‰²
            ctx.beginPath()
            ctx.arc(position.x, position.y, drawWidth, 0, 2 * Math.PI); // åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶å°åœ†å½¢è½¨è¿¹
            ctx.fill()
            interpolateAndDraw(movePos.x, movePos.y, position.x, position.y)
            movePos = position;
            ctx.restore();
        }
    }

    //ä¸ºäº†é¿å…é¼ æ ‡ç§»åŠ¨å¤ªå¿«å¯¼è‡´å°åœ†ç‚¹å‡ºç°æ–­å±‚ï¼Œgptå¸®æˆ‘å†™äº†ä¸ªæ’å€¼è¡¥è‰²å‡½æ•°ï¼Œæˆ‘å“­ä¼¼ï¼Œæˆ‘çœŸçš„å“­ä¼¼
    //(x1,y1)ä¸ºèµ·å§‹ç‚¹ï¼Œ(x2,y2)ä¸ºç›®æ ‡ç‚¹
    function interpolateAndDraw(x1, y1, x2, y2) {
        var dx = x2 - x1;
        var dy = y2 - y1;
        var distance = Math.sqrt(dx * dx + dy * dy);

        //æ­¥é•¿è¶…è¿‡5å³è¿›è¡Œæ’å€¼
        const step = 5
        if (distance > step) {
            var steps = Math.floor(distance / step);
            var xIncrement = dx / steps;
            var yIncrement = dy / steps;

            for (var i = 0; i < steps; i++) {
                var newX = x1 + (xIncrement * i);
                var newY = y1 + (yIncrement * i);
                ctx.fillStyle = drawColor; // è®¾ç½®å¡«å……é¢œè‰²ä¸ºç™½è‰²
                ctx.beginPath()
                ctx.arc(newX, newY, drawWidth, 0, 2 * Math.PI); // åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶å°åœ†å½¢è½¨è¿¹
                ctx.fill()
            }
        }
    }

    //ç‚¹å‡»é€‰æ‹©å®Œæ¯•æŒ‰é’®
    function showMeaningOnload(chrctData) {
        console.log("è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼šé€‰æ‹©ç¬”ç”»")
        phase = 99
        checkPhase()

        // console.log("é‡ç”»å­—çš„ä½ç½®ï¼Œè®¾ç½®åŸç‚¹ä¸º(canvasW * 1/3, canvasH * 1/2")
        ctx.translate(-PO.x, -PO.y)
        PO = { x: canvasW * 22 / 60, y: canvasH * 12 / 25 }
        ctx.translate(PO.x, PO.y)
        imgW = imgW * 0.5
        imgH = imgH * 0.5

        //æ¸…ç©ºç”»å¸ƒå¹¶æŠŠæ–°å›¾æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Š
        var modifiedSVG1 = svgDoc_leave.innerHTML;
        var blob1 = new Blob([modifiedSVG1], { type: "image/svg+xml" });
        img.src = URL.createObjectURL(blob1);
        img.onload = () => {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(-canvas.width, -canvas.height, canvas.width * 2, canvas.height * 2);
            ctx.drawImage(img, -imgW / 2, -imgH / 2, imgW, imgH);
        };

        clearDraw()
        console.log(chrctData);

        if(chrctData.description){
            document.getElementById("description").innerText="Explanation in 'Shuowen Jiezi':"+chrctData.description;
        }
        else{
            document.getElementById("description").innerText="";
        }
        var jiegouText = "Composition: ", spellText = "Pronunciation:", en_meaningText = "English Meaning:";
        var wordType = ["ç”²éª¨æ–‡", "é‡‘æ–‡å¤§ç¯†", "å°ç¯†", "éš¶ä¹¦"], wordTypeDes = ["Oracle Bone Script", "Large Seal Script", "Small Seal Script", "Clerical Script"];
        var jiegouDiv = document.getElementById("jiegou"), spellDiv = document.getElementById("spell"), en_hanyiDiv = document.getElementById("en_hanyi");
        jiegouDiv.innerHTML = "";



        // spellDiv.innerText = spellText + String(chrctData.spell);
        if(chrctData.spell){
            spellDiv.innerText=spellText+String(chrctData.spell);
        }
        else{
            spellDiv.innerText="";
        }

        if(chrctData.en_meaning!==""){
            en_hanyiDiv.innerText=en_meaningText + String(chrctData.en_meaning);
        }
        else{
            en_hanyiDiv.innerText="";
        }

        // en_hanyiDiv.innerText = en_meaningText + String(chrctData.en_meaning);
        console.log(chrctData.part_all);
        document.getElementById("word-font").innerHTML = "";
        var wordFontDiv = document.getElementById("word-font");
        if (wordFontDiv) {
            const imgName = chrctData.unicode+'.png';
            //wordType=["JiaGu","DaZhuan","XiaoZhuan","LiShu"];
            for (var i = 0; i < 4; ++i) {
                var newDiv = document.createElement("div");
                newDiv.className = "word-font__item";
                var newSpan1 = document.createElement("span"), newSpan2 = document.createElement("span");
                var srcDir='./'+wordType[i]+'/'+imgName;

                newSpan1.style.fontFamily = wordType[i];
                newSpan1.textContent = chrctData.word;

                newSpan2.className = "word-font__type";
                newSpan2.textContent = wordTypeDes[i];
                newDiv.appendChild(newSpan1);
                newDiv.appendChild(newSpan2);
                wordFontDiv.appendChild(newDiv);
            }
        }
        if(chrctData.part_all.length>0){
            jiegouDiv.innerText = jiegouText;
        if (chrctData.part_all == "#") {
            var newSpan = document.createElement("span");
            newSpan.innerText = "\"" + chrctData.word + "\"";
            jiegouDiv.appendChild(newSpan);
        }
        else {
            for (var i = 0; i < chrctData.part_all.length; ++i) {
                var newSpan = document.createElement("span");
                newSpan.innerText = "\"" + chrctData.part_all[i] + "\"";
                jiegouDiv.appendChild(newSpan);
                }
            }
        }

        var oDivWrap = document.querySelector('.wrap');
        oDivWrap.style.display = 'flex';
        //oDivWrap.style.left = canvasW * 3130 / 6580 + "px";
        //oDivWrap.style.top = canvasH * 880 / 4320 + "px";
    }

    //ä¹¦å†™å®Œæ¯•
    async function writeOver() {
        //åœæ­¢è§¦æ‘¸äº‹ä»¶
        isDraw = false
        canvas.ontouchstart = null
        canvas.ontouchmove = null
        canvas.ontouchend = null

        const image = new Image();
        image.src = canvas.toDataURL('image/png');
        timeoutId = null
        phase = 2 //ä¸ºé¿å…ä¸¤æ¬¡å‘é€è¯·æ±‚ï¼Œè¿™é‡Œé©¬ä¸Šèµ‹å€¼ä¸º2
        var wordInfo1 = "", wordInfo2 = "", wordInfo3 = "";

        await axios({
            method: 'POST',
            url: '/recognize',
            data: {
                "data": image.src,
            }
        })
        .then(async res => {
            console.log("æ‰“å°ä¸€ä¸‹è¯†åˆ«ç»“æœ", res.data)
            if (res.data.code === 512) {
                // alert("è¯†åˆ«åˆ°è¶…å‡ºä¸€ä¸ªå­—ï¼Œè¿˜è¯·æ‚¨å†™çš„ç´§å‡‘äº›~")
                alert("Detected more than one character. Please write only one character.")
                backWrite()
            }
            else if (res.data.code === 511) {
                // alert("æ— æ³•æ­£ç¡®è¯†åˆ«ï¼Œè¿˜è¯·æ‚¨é‡æ–°ä¹¦å†™~")
                alert("Unable to recognize correctly. Please rewrite it for me.")
                backWrite()
            }
            else {
                clearDraw()

                //è¯·æ±‚æ–‡å­—ä¿¡æ¯
                await axios({
                    method: 'GET',
                        url: 'https://x-chinese-api.ykt.eduyun.cn/v1/chinese/definitions?word=' + String(res.data.ch),
                })
                .then(res2 => {
                    console.log("è¯·æ±‚æ–‡å­—ä¿¡æ¯1", res2.data)
                    wordInfo1 = res2.data
                })
                .catch(error2 => {
                    console.log("è¯·æ±‚æ–‡å­—ä¿¡æ¯1é”™è¯¯", error2.message)
                });

                await axios({
                    method: 'GET',
                        url: 'https://x-chinese-api.ykt.eduyun.cn/v1/chinese/words?word=' + String(encodeURI(res.data.ch)),

                })
                .then(res3 => {
                    console.log("è¯·æ±‚æ–‡å­—ä¿¡æ¯2", res3.data)
                    wordInfo2 = res3.data
                })
                .catch(error3 => {
                    console.log("è¯·æ±‚æ–‡å­—ä¿¡æ¯2é”™è¯¯", error3.message)
                });


                await axios({
                    method: 'POST',
                    url: '/meaning',
                    data: {
                        "url": "https://ctext.org/dictionary.pl",
                            "word": res.data.ch,
                    }
                })
                .then(res4 => {
                    if (res4.data.success) {
                        console.log("è¯·æ±‚æ–‡å­—ä¿¡æ¯3", res4.data.meaning)
                        wordInfo3 = res4.data.meaning
                    }
                    else {
                        console.log("è¯·æ±‚apié”™è¯¯", res4.data.message)
                    }

                })
                .catch(error4 => {
                    console.log("è¯·æ±‚meaningé”™è¯¯", error4.message)
                })

                var part_all = wordInfo2.jiegou.part_all, partList = new Array();
                for (var i = 0; i < part_all.length; ++i) {
                    partList.push(part_all[i]);
                }

                console.log("wordInfo3", wordInfo3)

                var showInfo = {
                    "word": res.data.ch,
                    "unicode": res.data.unicode,
                    "description": wordInfo1.description,
                    "spell": wordInfo1.spell,
                    "part_all": partList,
                    "en_meaning": wordInfo3,

                }

                await showOnload(res.data.unicode, res.data.ch);
                await showMeaningOnload(showInfo);
            }
        })
        .catch(err => {
            console.log("å‘ç”Ÿé”™è¯¯",err)
            alert('ç½‘ç»œé”™è¯¯');
            backWrite();
        });
    }
</script>

<!-- é€‰æ‹©éƒ¨åˆ† -->
<script>
    var chosenStrokes = [];   //ç”¨ä»¥è®°å½•éƒ½é€‰ä¸­äº†ç¬”ç”»çš„å“ªå‡ ç¬”

    const PINK = "FFC0CB"
    const GREY = "808080"

    var svgPath = ''
    var svgDoc_leave = ''
    var svgDoc_send = ''
    //è®¾ç½®è¿™ä¸ªå˜é‡æ˜¯å› ä¸ºæœ€åä¸€é¡µæœ‰ä¸ªâ€œé‡æ–°è¾“å…¥æ ‡ç­¾â€çš„æŒ‰é’®ï¼Œä½†æ˜¯è¿™æ—¶å€™svgDoc_leaveä¸­å·²ç»æœ‰ç¬”ç”»è¢«åˆ é™¤äº†
    //å› æ­¤åœ¨åˆ é™¤ç¬”ç”»ä¹‹å‰å…ˆæŠŠå†…å®¹æ·±æ‹·è´ä¸€ä»½æ”¾åœ¨è¿™é‡Œé¿å…æŠ¥é”™
    var svgDoc_leave_deepcopy = ''

    var imgH, imgW, beginX, beginY;
    var rotate = 0;
    var scale = 1;
    //è¿™é‡Œç”¨æ”¹å˜åæ ‡åŸç‚¹çš„æ–¹å¼æ¥ç”»å›¾ï¼Œè®©åæ ‡åŸç‚¹å§‹ç»ˆåœ¨å›¾ç‰‡çš„ä¸­å¿ƒ


    var initImgW = 400;
    var initImgH = 400;
    var img = new Image();
    var oldInputEng = '';
    var oldBase64 = '';

    function backWrite() {
        console.log("ä»é€‰æ‹©ç¬”ç”»è¿”å›é‡å†™")
        //ä¸æ˜¾ç¤ºâ€œé‡å†™â€æŒ‰é’®
        var backWriteCSS = document.getElementById('backWriteCSS')
        backWriteCSS.style.display = "none"
        //ä¸æ˜¾ç¤ºâ€œé€‰æ‹©å®Œæ¯•â€æŒ‰é’®
        var selectbtn = document.getElementById('selectbtn');
        selectbtn.style.display = "none";

        phase = 1
        ctx.translate(-PO.x, -PO.y)
        writeOnload()
    }

    //windowå±å¹•åæ ‡è½¬åŒ–ä¸ºcanvasåæ ‡
    convertCoordinate = function (x, y) {
        //åœ¨å±å¹•åæ ‡ç³»ä¸­ï¼Œç›¸å¯¹canvasåæ ‡ç³»åŸç‚¹POçš„åç§»,æ‰€ä»¥è¦å‡å»canvasåæ ‡åŸç‚¹
        x = x - PO.x;
        y = y - PO.y;
        return { x: x, y: y }
    }

    //è¿™ä¸ªå‡½æ•°åœ¨handleClickä¸­è°ƒç”¨ï¼Œä½œç”¨æ˜¯ï¼šåˆ¤å®šè¿™ä¸ªé€‰ä¸­çš„é¢œè‰²æ˜¯ç²‰è‰²è¿˜æ˜¯ç°è‰²
    //ä¼ å…¥é¢œè‰²ä¸º16è¿›åˆ¶
    function isColorGrey(chosenColor) {
        var decimalNumber = parseInt(chosenColor, 16)
        var standard = parseInt(GREY, 16)
        if (Math.abs(standard - decimalNumber) < 30) {
            return true
        }
        return false
    }

    //è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†å½¢å¦‚rgb(128, 128, 128)çš„å­—ç¬¦ä¸²æ”¹ä¸º"808080"å­—ç¬¦ä¸²
    //ç¼–å†™è¿™ä¸ªå‡½æ•°çš„åŸå› è§getSvgContentå‡½æ•°é‡Œçš„æ³¨é‡Š
    function RGB2Hex(CSSColor) {
        // ä» rgbString ä¸­æå–ä¸‰ä¸ªåˆ†é‡å€¼
        var rgbValues = CSSColor.match(/\d+/g);
        var r = parseInt(rgbValues[0]);
        var g = parseInt(rgbValues[1]);
        var b = parseInt(rgbValues[2]);

        // å°†ä¸‰ä¸ªåˆ†é‡å€¼è½¬æ¢ä¸ºåå…­è¿›åˆ¶ï¼Œå¹¶æ‹¼æ¥æˆæœ€ç»ˆçš„é¢œè‰²å­—ç¬¦ä¸²
        var hexColor = ((r << 16) | (g << 8) | b).toString(16).padStart(6, "0").toUpperCase();
        return hexColor;
    }

    function handleClick(chosenColor) {
        //è·å–ç‚¹å‡»çš„æ˜¯å“ªä¸€ä¸ªç¬”ç”»ï¼Œç°çš„å˜çº¢(PINK-i)ï¼Œçº¢çš„å˜ç°(808080-i)ï¼Œiä¸ºç¬”ç”»é¡ºåºï¼Œå–å€¼0,1,2,...
        var paths = svgDoc_leave.getElementsByTagName("path");
        var strokeNum = paths.length; //è¯¥å­—çš„ç¬”ç”»æ•°ç›®
        for (var i = 0; i < strokeNum; i++) {
            var element = svgDoc_leave.querySelector(".stroke" + (i + 1));
            if ("#" + RGB2Hex(element.style.fill) == chosenColor) {
                if (isColorGrey(RGB2Hex(element.style.fill))) {
                    console.log("é€‰ä¸­çš„æ˜¯ç°è‰²çš„ç¬”ç”»")
                    //gptå¸®æˆ‘å†™çš„ï¼Œè®¾ç½®æˆæ¯”å®å®šä¹‰PINKå°_içš„æ•°çš„å­—ç¬¦ä¸²
                    var decimalNumber = parseInt(PINK, 16);
                    var decimalNumberMinusOne = decimalNumber - i;
                    var hexadecimalResult = decimalNumberMinusOne.toString(16).toUpperCase();
                    var paddedResult = hexadecimalResult.padStart(6, "0");
                    element.style.fill = "#" + paddedResult;
                }
                else {
                    console.log("é€‰ä¸­çš„æ˜¯çº¢è‰²çš„ç¬”ç”»")
                    //gptå¸®æˆ‘å†™çš„ï¼Œè®¾ç½®æˆæ¯”å®å®šä¹‰GREYå°_içš„æ•°çš„å­—ç¬¦ä¸²
                    var decimalNumber = parseInt(GREY, 16);
                    var decimalNumberMinusOne = decimalNumber - i;
                    var hexadecimalResult = decimalNumberMinusOne.toString(16).toUpperCase();
                    var paddedResult = hexadecimalResult.padStart(6, "0");
                    element.style.fill = "#" + paddedResult;
                }
                break
            }
        }


        //åœ¨canvasä¸Šæ˜¾ç¤ºå‡ºæ¥
        var modifiedSVG1 = svgDoc_leave.innerHTML;
        // ä½¿ç”¨ FileSaver.js æˆ–å…¶ä»–æ–¹æ³•æ¥ä¿å­˜ modifiedSVG åˆ°ä½ çš„è®¡ç®—æœº
        // åˆ›å»ºä¸€ä¸ªBlobå¯¹è±¡æ¥ä¿å­˜ä¿®æ”¹åçš„SVGæ–‡ä»¶å†…å®¹
        var blob1 = new Blob([modifiedSVG1], { type: "image/svg+xml" });
        //æ¸…ç©ºç”»å¸ƒå¹¶æŠŠæ–°å›¾æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Š
        const img = new Image();
        img.src = URL.createObjectURL(blob1);
        img.onload = () => {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(-canvas.width, -canvas.height, canvas.width * 2, canvas.height * 2);
            ctx.drawImage(img, -imgW / 2, -imgH / 2, imgW, imgH);
        };
    }

    async function showOnload(uni, ch) {
        //å…ˆåˆ¤æ–­æ˜¯å¦çœŸçš„æœ‰è¿™ä¸ªå­—
        svgPath = './character/' + uni + '.svg'

        //åˆå§‹åŒ–svgDocä»¬
        //å› ä¸ºHTML-jsä¸èƒ½ä¿å­˜æ–‡ä»¶ï¼Œå› æ­¤æˆ‘åªèƒ½é¢å¤–å®šä¹‰å˜é‡ä¸“é—¨å­˜æ”¾ç”»å¸ƒä¸Šåº”è¯¥æ˜¾ç¤ºçš„svgçš„å†…å®¹äº†
        //è¿™é‡Œå®šä¹‰äº†ï¼š
        //
        //svgDoc_leaveï¼Œç”»å¸ƒä¸Šè¯¥æ˜¾ç¤ºçš„svgçš„å†…å®¹
        //svgDoc_sendï¼Œè¯¥å‘é€ç»™åç«¯æ¸²æŸ“çš„svgçš„å†…å®¹
        //svgDoc_initialï¼Œsvgæœ€åˆçš„å†…å®¹ï¼Œé¿å…äºŒæ¬¡è¯»å–äº†ï¼Œå› ä¸ºå¼‚æ­¥å¾ˆéº»çƒ¦
        //
        //æœ¬å‡½æ•°çš„åŠŸèƒ½æ˜¯ï¼šåˆå§‹åŒ–svgDocï¼Œç”»å¸ƒä¸Šæœ€å¼€å§‹æ˜¾ç¤ºçš„å°±æ˜¯åŸsvg
        await new Promise((resolve, reject) => {
            try {
                //ç¦»è°±äº†ï¼Œä½ è¿™é‡Œè¿˜ä¸èƒ½åˆ æ‰è¿™å¥çœ‹ä¼¼å¤šä½™çš„.then(response => response.text())ï¼Œä¸ç„¶å¯„æ‰äº†
                fetch(svgPath)
                    .then(response => {
                        if (!response.ok) {
                            // throw new Error('Network response was not ok');
                            //å› ä¸ºè¿™ä¸ªOCRè¿˜æŒºæœ‰æ„æ€ï¼Œå†™ä¸ªå­—æ¯a,ä»–çœŸçš„ç»™ä½ è¿”å›unicodeæ˜¯97
                            console.log('å…¶å®æ˜¯å­—åº“é‡Œæ²¡æœ‰é‚£ä¸ªunicodeï¼Œä½†å¯¹ç”¨æˆ·ä¸èƒ½è¿™æ ·è¯´', response)
                            // alert("æ‚¨è¾“å…¥çš„æ˜¯ã€Œ" + ch + "ã€å—ï¼Ÿæ­å–œæ‚¨å‘ç°äº†ç³»ç»Ÿçš„è¾¹ç•Œï¼Œè¯·å°è¯•è¾“å…¥å…¶ä»–æ±‰å­—ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿä¹Ÿå°†ç»§ç»­å®Œå–„")
                            alert("Isã€Œ" + ch + "ã€your input? Congratulations on discovering the system's limitation! Please try entering other Chinese characters, and our system will continue to improve.")

                            backWrite()
                            reject("åœ¨åˆå§‹åŒ–svgçš„å‡½æ•°é‡Œè¢«æŠ›å‡º")
                        }
                        return response.text()
                    })
                    .then(data => {
                        var svgDoc = document.createElement("div")
                        svgDoc.innerHTML = data
                        //å› ä¸ºé€šè¿‡querySelectorè®¾ç½®fillé¢œè‰²ï¼Œæ˜¯è®¾ç½®åœ¨pathæ ‡ç­¾ä¸‹æ·»åŠ ä¸€ä¸ªstyleï¼Œè€Œä¸æ˜¯ä¿®æ”¹styleæ ‡ç­¾ä¸‹çš„cssæ ·å¼
                        //æ‰€ä»¥ä½ è¿˜ä¸èƒ½ç›´æ¥æŠŠdataèµ‹å€¼ç»™innerHTMLï¼Œè¦å…ˆæŒ‰ç…§styleè®¾ç½®ä¸€ä¸‹æ‰€æœ‰pathçš„style="fill:??"ï¼Œé¿å…ä¹‹åquerySelector().style.fillè·å¾—çš„æ˜¯null
                        var paths = svgDoc.getElementsByTagName("path");
                        var strokeNum = paths.length; //è¯¥å­—çš„ç¬”ç”»æ•°ç›®
                        for (var i = 1; i <= strokeNum; i++) {
                            var element = svgDoc.querySelector(".stroke" + i);
                            var decimalNumber = parseInt(GREY, 16);
                            var decimalNumberMinusOne = decimalNumber - (i - 1);
                            var hexadecimalResult = decimalNumberMinusOne.toString(16).toUpperCase();
                            var paddedResult = hexadecimalResult.padStart(6, "0");
                            //è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå°½ç®¡èµ‹çš„å€¼æ˜¯#808080ï¼Œä½†è¿›å…¥fillæ ·å¼çš„æ˜¯åŸç”ŸCSSé¢œè‰²è¡¨ç¤ºæ ·å¼rgb(128, 128, 128)
                            //å› æ­¤ä½¿ç”¨æ—¶éœ€è¦é¢å¤–è½¬åŒ–ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªRGB2Hexå‡½æ•°
                            element.style.fill = "#" + paddedResult;
                            element.style.display = 'block'
                            // console.log("#"+paddedResult)
                            // console.log(element.style.fill)
                        }

                        svgDoc_initial = svgDoc.cloneNode(true)
                        svgDoc_send = svgDoc.cloneNode(true)
                        svgDoc_leave = svgDoc.cloneNode(true)
                        resolve(svgDoc)
                    })
            }
            catch (error) {
                //å› ä¸ºè¿™ä¸ªOCRè¿˜æŒºæœ‰æ„æ€ï¼Œå†™ä¸ªå­—æ¯a,ä»–çœŸçš„ç»™ä½ è¿”å›unicodeæ˜¯97
                console.log('å…¶å®æ˜¯å­—åº“é‡Œæ²¡æœ‰é‚£ä¸ªunicodeï¼Œä½†å¯¹ç”¨æˆ·ä¸èƒ½è¿™æ ·è¯´', error)
                // alert("æ— æ³•æ­£ç¡®è¯†åˆ«ï¼Œè¿˜è¯·æ‚¨é‡æ–°ä¹¦å†™~")
                alert("Unable to recognize correctly. Please rewrite it for me ~")
                backWrite()
            }

        })

        //ç„¶åå†è£…è½½å›¾ç‰‡
        await new Promise((resolve, reject) => {
            initImgH = canvasH * 0.6
            initImgW = canvasH * 0.6
            img.src = svgPath;
            img.onload = function () {
                imgH = initImgW
                imgW = initImgH
                //è®°å½•ä¸€ä¸‹canvasåŸç‚¹  ä¸ºå›¾ç‰‡çš„ä¸­å¿ƒç‚¹,å› ä¸ºæ—‹è½¬å›¾æ ‡åœ¨å¤–é¢ï¼Œåˆå§‹åŒ–æ”¹å˜ä¸€ä¸‹ä½ç½®ï¼Œç¦»è¾¹è¿œä¸€ç‚¹
                PO = { x: canvasW / 2, y: canvasH / 2 };
                //æ”¹å˜ç”»å¸ƒçš„ä¸­å¿ƒç‚¹
                ctx.translate(PO.x, PO.y)
                drawSVG();
                resolve()
            }
            img.onerror = function () {
                //å› ä¸ºè¿™ä¸ªOCRè¿˜æŒºæœ‰æ„æ€ï¼Œå†™ä¸ªå­—æ¯a,ä»–çœŸçš„ç»™ä½ è¿”å›unicodeæ˜¯97
                console.log('å…¶å®æ˜¯å­—åº“é‡Œæ²¡æœ‰é‚£ä¸ªunicodeï¼Œä½†å¯¹ç”¨æˆ·ä¸èƒ½è¿™æ ·è¯´', 'æœ¬æŠ¥é”™ç”±img.onerroræŠ›å‡º')
                alert("æ— æ³•æ­£ç¡®è¯†åˆ«ï¼Œè¿˜è¯·æ‚¨é‡æ–°ä¹¦å†™~")
                backWrite()
                reject()
            }
        })

        //å†æ¥æ“ä½œphaseä¹Ÿä¸è¿Ÿï¼ï¼ï¼
        checkPhase()

        //è¯»å–ç”»å¸ƒä¸Šæœ‰é¼ æ ‡è¢«æŒ‰ä¸‹ï¼Œå®æ—¶æ›´æ–°ä½ç½®æ˜¾ç¤ºå¹¶åˆ¤å®šæ˜¯å¦æ‹–åŠ¨
        canvas.onmousedown = async function (e) {
            //e.offsetXæ˜¯é¼ æ ‡ç‚¹å‡»åˆ°canvasè¾¹çš„ä½ç½®
            beginX = e.offsetX;
            beginY = e.offsetY;
            //æŠŠç‚¹å‡»çš„winåæ ‡è½¬ä¸ºcanvasåæ ‡
            var Cp = convertCoordinate(beginX, beginY)
            let imageData = ctx.getImageData(e.layerX, e.layerY, 1, 1)
            chosenColor = '#' + ("0" + imageData.data[0].toString(16)).substr(-2).toUpperCase()
                + ("0" + imageData.data[1].toString(16)).substr(-2).toUpperCase()
                + ("0" + imageData.data[2].toString(16)).substr(-2).toUpperCase()   // è½¬æ¢ä¸º16è¿›åˆ¶

            await handleClick(chosenColor)
        }
    }

    //ç”»å›¾
    function drawSVG() {
        //å…ˆæ¸…é™¤ç”»å¸ƒï¼Œæ¸…é™¤ä¸¤å€çš„ç”»å¸ƒï¼Œå› ä¸ºè¦æ”¹å˜åæ ‡åŸç‚¹ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½ä¸ç®¡åŸç‚¹åœ¨å“ªé‡Œéƒ½èƒ½å®Œå…¨æ¸…é™¤ç”»å¸ƒ
        ctx.clearRect(-canvas.width, -canvas.height, canvas.width * 2, canvas.height * 2);
        //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
        ctx.drawImage(img, -imgW / 2, -imgH / 2, imgW, imgH);
    }

</script>

<!-- è¾“å…¥æ ‡ç­¾å¹¶æ¸²æŸ“ -->
<script>

    // è¿™ä¸ªå˜é‡ç”¨æ¥è®°å½•æ˜¯å¦å·²ç»æ¸²æŸ“å®Œæ¯•
    // åˆšè¿›å…¥renderå‡½æ•°æ—¶ç½®falseï¼›æ‰‹åŠ¨å–æ¶ˆã€æ¸²æŸ“å‡ºé”™ã€æ¸²æŸ“å®Œ6å¼ åç½®true
    // å®šä¹‰å®ƒçš„ç›®çš„æ˜¯ï¼šaxios.allå¹¶å‘äº†6ä¸ªè¯·æ±‚ï¼Œå‘å‡ºå»äº†å°±æ— æ³•æ”¶å›åªèƒ½â€æ‹¦æˆªâ€œã€‚
    // å¦‚æœåªæ¸²æŸ“äº†3å¼ å°±å–æ¶ˆï¼Œåé¢è‹¥è¿˜ç»§ç»­æ¥å—å‰©ä¸‹çš„3å¼ å›¾ç‰‡ï¼Œå¯èƒ½ä¼šä¸¥é‡æŠ¥é”™
    // ä½†æ˜¯è¿™é‡Œå·æ‡’æ²¡æœ‰ä½¿ç”¨æ‹¦æˆªå™¨ï¼Œå®šä¹‰äº†ä¸€ä¸ªå˜é‡å……å½“æ‹¦æˆªå™¨çš„ä½œç”¨ï¼Œå³è‹¥å®ƒæ˜¯trueï¼Œé‚£å°±ä¸pushäº†ï¼Œå…·ä½“åœ¨requestA~Få‡½æ•°å†…èƒ½çœ‹åˆ°
    var renderOver = false

    var renderRsultData = [] //è®°å½•æ¸²æŸ“ç»“æœï¼Œä¸€å…±å…­ä¸ªå…ƒç´ 

    //thanks to chatgptï¼Œæˆ‘å¯ä»¥é€šè¿‡å®šæ—¶å‡½æ•°è®¾ç½®ä¸€ä¸ªé—ªçƒçš„åŠŸèƒ½
    // è®¾ç½®å¼€å§‹å’Œç»ˆæ­¢çš„æ ‡å¿—
    let isTaskRunning = false;
    let intervalId = null;
    // å¼€å§‹å®šæ—¶ä»»åŠ¡
    function startTask() {
        if (!isTaskRunning) {
            isTaskRunning = true;
            intervalId = setInterval(myFunction, 500); // æ¯éš”0.5ç§’æ‰§è¡Œ myFunction å‡½æ•°
        }
    }
    // ç»ˆæ­¢å®šæ—¶ä»»åŠ¡
    function stopTask() {
        if (isTaskRunning) {
            clearInterval(intervalId);
            isTaskRunning = false;
        }
    }
    // å®šä¹‰è¦æ‰§è¡Œçš„å‡½æ•°
    function myFunction() {
        console.log("è¿™æ˜¯å®šæ—¶ä»»åŠ¡çš„å‡½æ•°");
        var paths = svgDoc_leave.getElementsByTagName("path")
        //å¯¹svgDoc_leaveè®¾ç½®å¯ä¸å¯è§
        for (var i = 1; i <= paths.length; i++) {
            var element = svgDoc_leave.querySelector(".stroke" + i)
            if (!isColorGrey(RGB2Hex(element.style.fill))) {
                //è‹¥è¢«é€‰ä¸­çš„ç¬”ç”»å¯è§ï¼Œåˆ™è®¾ç½®ä¸å¯è§ï¼›åä¹‹è®¾ç½®ä¸ºå¯è§ï¼Œä»¥å®ç°é—ªçƒçš„æ•ˆæœ
                if (element.style.display == 'none') {
                    element.style.display = 'block'
                }
                else {
                    element.style.display = 'none'
                }
            }
        }

        //æ¸…ç©ºå³åŠä¾§ç”»å¸ƒå¹¶æŠŠæ–°å›¾æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Š
        var modifiedSVG1 = svgDoc_leave.innerHTML;
        var blob1 = new Blob([modifiedSVG1], { type: "image/svg+xml" });
        img.src = URL.createObjectURL(blob1);
        img.onload = () => {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(canvas.width / 2, 0, canvas.width, canvas.height);
            ctx.drawImage(img, canvasW / 1404 * 840 - imgW / 2, canvasH / 1080 * 440 - imgH / 2, imgW*1.5, imgH*1.5);
        }
    }

    //æ˜¾ç¤ºè’™ç‰ˆå¹¶ç¦æ­¢ç”¨æˆ·é™¤modalä»¥å¤–çš„æ‰€æœ‰æ“ä½œ
    function disablePage() {
        var overlay = document.getElementById("overlay");
        overlay.style.backgroundColor = "rgba(0, 0, 0, 0.6)"
        overlay.style.display = "block";

        var elements = document.querySelectorAll("body > *:not(#modal)");
        elements.forEach(function (element) {
            element.classList.add("disabled");
        });
    }
    //åˆ é™¤è’™ç‰ˆå¹¶æ¢å¤modalä»¥å¤–çš„æ‰€æœ‰é¡µé¢æ“ä½œ
    function enablePage() {
        var overlay = document.getElementById("overlay");
        overlay.style.display = "none";

        var elements = document.querySelectorAll("body > *:not(#modal)");
        elements.forEach(function (element) {
            element.classList.remove("disabled");
        });
    }

    //ç‚¹å‡»é€‰æ‹©å®Œæ¯•æŒ‰é’®
    function slectedOver() {
        console.log("è¿›å…¥ç¬¬ä¸‰é˜¶æ®µï¼šè¾“å…¥æ ‡ç­¾")
        phase = 3
        checkPhase()

        // console.log("é‡ç”»å­—çš„ä½ç½®ï¼Œè®¾ç½®åŸç‚¹ä¸º(canvasW * 1/3, canvasH * 1/2")
        ctx.translate(-PO.x, -PO.y)
        PO = { x: canvasW * 22 / 60, y: canvasH * 1 / 2 }
        ctx.translate(PO.x, PO.y)
        // imgW = imgW * 0.5
        // imgH = imgH * 0.5

        //æ¸…ç©ºç”»å¸ƒå¹¶æŠŠæ–°å›¾æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Š
        var modifiedSVG1 = svgDoc_leave.innerHTML;
        var blob1 = new Blob([modifiedSVG1], { type: "image/svg+xml" });
        img.src = URL.createObjectURL(blob1);
        img.onload = () => {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(-canvas.width, -canvas.height, canvas.width * 2, canvas.height * 2);
            ctx.drawImage(img, -imgW / 2, -imgH / 2, imgW, imgH);
        };

        // å‡ºç°é€‰æ‹©æ¡†
        clearDraw()
        showInput()
        var oDivWrap = document.querySelector('.wrap');
        oDivWrap.style.display = 'none';
    }

    //å±•ç¤ºè¾“å…¥æ¡†
    function showInput() {
        const inputContainer = document.getElementById("container");
        const inputBar = inputContainer.querySelector(".inputRenderLabelBar");
        const inputButton = inputContainer.querySelector(".inputRenderLabelBtn");
        // å°†è¾“å…¥æ¡†æ˜¾ç¤ºåœ¨ç›¸åº”ä½ç½®
        inputContainer.style.display = "flex"
        inputContainer.style.left = canvasW * 3130 / 6580 + "px";
        inputContainer.style.top = canvasH * 1825 / 4320 + "px";

        //è®¾ç½®inputBaré•¿åº¦
        inputBar.style.width = canvasW * 600 / 1980 + "px";
        inputBar.style.height = canvasH * 70 / 1367 + "px";
    }

    // éšè—è¾“å…¥æ¡†
    async function hideInput() {
        const inputBox = document.getElementById("container");
        var inputEng = inputBox.querySelector("input").value
        await axios({
            method: 'POST',
            url: '/translate',
            data: {
                "text": inputBox.querySelector("input").value,
            }
        })
            .then(res => {
                inputEng = res.data.translation
            })
            .catch(error => {
                console.log('ç¿»è¯‘å‡ºç°é”™è¯¯', error.message)
            })

        console.log("ä½ è¾“å…¥çš„è‹±æ–‡æ˜¯", inputEng)
        return new Promise((resolve, reject) => {
            //1. è·å–æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Šçš„å’Œè¯¥å‘é€ç»™æ¥å£çš„å›¾ç‰‡
            var paths = svgDoc_send.getElementsByTagName("path");
            var strokeNum = paths.length
            //æˆ‘å»ï¼ŒchatgptçœŸçš„å¥½ç‰›ï¼Œåˆ é™¤ä¼šæ”¹å˜ä¸‹æ ‡ï¼Œæˆ‘ç›´æ¥ä»åå¾€å‰å°±å¥½äº†
            for (var i = strokeNum; i > 0; i--) {
                //å¯¹svgDoc_leaveçš„ç¬”ç”»é¢œè‰²ä¸‹æ‰‹
                var strokeHexColor = RGB2Hex(svgDoc_leave.querySelector(".stroke" + i).style.fill)
                if (isColorGrey(strokeHexColor)) {
                    //æœªè¢«é€‰ä¸­ï¼Œåˆ™å‘é€æ¸²æŸ“çš„åˆ é™¤
                    paths[i - 1].remove();
                }
                else {
                    //å·²è¢«é€‰ä¸­ï¼Œåˆ™å‘é€æ¸²æŸ“çš„å˜é»‘
                    svgDoc_send.querySelector(".stroke" + i).style.fill = 'black'
                }
            }

            //2. å°†è¯¥å‘é€çš„å‘é€å‡ºå»
            var modifiedSVG = svgDoc_send.innerHTML
            // è·å– SVG æ ¹èŠ‚ç‚¹
            var svgRoot = svgDoc_send.firstChild;
            // åˆ›å»ºä¸€ä¸ªæ–°çš„ Image å¯¹è±¡
            var iiimggg = new Image();
            // å°† SVG è½¬æ¢ä¸ºå›¾ç‰‡
            iiimggg.src = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(modifiedSVG)));
            // å½“ SVG è½¬åŒ–ä¸ºå›¾ç‰‡æ—¶è§¦å‘
            iiimggg.onload = async function () {
                // åˆ›å»ºä¸€ä¸ª Canvas å…ƒç´ 
                var canvas1 = document.createElement('canvas');
                canvas1.width = iiimggg.width;
                canvas1.height = iiimggg.height;

                // åœ¨ Canvas ä¸Šç»˜åˆ¶ SVG
                var ctx1 = canvas1.getContext('2d');
                ctx1.drawImage(iiimggg, 0, 0);
                // å°† Canvas è½¬æ¢ä¸º base64 ç¼–ç çš„å›¾ç‰‡
                var base64Image = canvas1.toDataURL();

                oldInputEng = inputEng    //è®°å½•ï¼Œæ–¹ä¾¿å›ä¼ 
                oldBase64 = base64Image   //è®°å½•

                await render(inputEng, base64Image)
            };
        })
    }

    async function render(inputEng, base64Image) {
        console.log("base64å¾…æ¸²æŸ“", base64Image)
        // ç½®å¦
        renderOver = false

        i = 1
        //æ¸…ç©ºæ•°ç»„
        renderRsultData.length = 0;
        // åˆ›å»ºä¸€ä¸ª AbortController å®ä¾‹
        const controller = new AbortController();
        // è·å–å¼¹çª—å…ƒç´ å¯¹è±¡
        var modal = document.getElementById("modal");
        //å…ˆæŠŠå®ƒç½®ä¸ºæœ€åº•å±‚
        modal.style.zIndex = 1;
        // è·å–å–æ¶ˆæŒ‰é’®å…ƒç´ å¯¹è±¡
        var cancel = document.getElementById("cancel");
        // å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨æ¥å­˜å‚¨å·²åŠ è½½æˆåŠŸçš„å›¾ç‰‡æ•°é‡
        var count = 0;
        document.getElementById("count").textContent = count;

        // ç»™å–æ¶ˆæŒ‰é’®æ·»åŠ  click äº‹ä»¶ç›‘å¬å™¨ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åè‡ªåŠ¨åˆ é™¤è‡ªå·±ï¼Œé¿å…ä¸‹ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™å°±æ²¡æœ‰è’™ç‰ˆäº†
        const cancelRender = function () {
            // è°ƒç”¨ AbortController çš„ abort æ–¹æ³•ï¼Œå–æ¶ˆè¯·æ±‚
            controller.abort();
            // ç½®æ˜¯
            renderOver = true
            console.log("ç”¨æˆ·ç‚¹å‡»å–æ¶ˆæŒ‰é’®")
            // éšè—å¼¹çª—
            modal.classList.add("hidden");
            // å–æ¶ˆè’™ç‰ˆå¹¶æ¢å¤ç”¨æˆ·æ“ä½œç½‘é¡µ
            enablePage()
            // è°ƒç”¨å®Œæ¯•åè‡ªåŠ¨åˆ é™¤è‡ªå·±
            cancel.removeEventListener('click', cancelRender)
            console.log(renderRsultData)
            showsixOnload(renderRsultData, sucnum)
        }
        cancel.addEventListener("click", cancelRender)

        //æˆåŠŸåŠ è½½çš„æ•°ç›®
        var sucnum = 0;
        console.log(getCookie("userId"));

        // å°è£…æ¥å£ A çš„è¯·æ±‚å‡½æ•°
        function requestA(i, controller) {
            return axios({
                method: "POST",
                url: "/render",
                data: {
                    base64: base64Image,
                    prompt: inputEng,
                    batch_size: 1,
                    n_iter: 2,
                },
                signal: controller.signal,
            }).then((res) => {
                if (!renderOver) {
                    renderRsultData.push(res.data);
                    count++;
                    document.getElementById("count").textContent = count;
                    //console.log("ç¬¬" + i + "è½®æ¸²æŸ“æˆåŠŸï¼Œç”±åŸæœåŠ¡å™¨å®Œæˆ");
                    console.log("æ¸²æŸ“æˆåŠŸï¼Œç”±æ¥å£Aå®Œæˆ");
                    sucnum++;

                    //å¼€æ”¾modalè’™ç‰ˆè®¿é—®
                    if (i == 1) {
                        modal.style.zIndex = 1000;
                    }
                }
            });
        }

        const promises = [
            requestA(i, controller),
            requestA(i, controller),
            requestA(i, controller),
            requestA(i, controller),
            requestA(i, controller),
            requestA(i, controller)
        ]

        // ä½¿ç”¨ Promise.all å®ç°å¹¶å‘å¤„ç†æ•°æ®       
        try {
            sucnum = 0;
            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.remove("hidden");
            //æ˜¾ç¤ºè’™ç‰ˆå¹¶ç¦æ­¢ç”¨æˆ·å…¶ä»–æ“ä½œ
            disablePage()
            console.log("ä¸€æ¬¡æ¸²æŸ“6å¼ ")

            await axios.all(promises);

            // éšè—å¼¹çª—
            modal.classList.add("hidden");
            //å–æ¶ˆè’™ç‰ˆå¹¶æ¢å¤ç”¨æˆ·å…¶ä»–æ“ä½œ
            enablePage()
        }
        catch (error) {
            //å¦‚æœç”¨æˆ·è‡ªå·±ç‚¹å‡»å–æ¶ˆæŒ‰é’®
            if (error.message == 'canceled') {
                console.log('æ¥å£æ­£å¸¸æ—¶å–æ¶ˆæ¸²æŸ“', error.message);
                // ä¸­æ­¢æ¸²æŸ“è¯·æ±‚
                controller.abort();
                // ä¹‹åçš„æ¸²æŸ“è·å–åˆ°ç»“æœä¸å†å¤„ç†
                renderOver = false
                // éšè—å¼¹çª—
                modal.classList.add("hidden");
                //å–æ¶ˆè’™ç‰ˆå¹¶æ¢å¤ç”¨æˆ·å…¶ä»–æ“ä½œ
                enablePage()
            }
            // å¦‚æœå‡ºç°é”™è¯¯æˆ–è¶…æ—¶ï¼Œä½¿ç”¨æ¥å£ F å®Œæˆå‰©ä½™çš„å›¾ç‰‡æ¸²æŸ“
            else {
                console.log("å‡ºç°é”™è¯¯æˆ–è¶…æ—¶", error.message);
                // ä¹‹åçš„æ¸²æŸ“è·å–åˆ°ç»“æœä¸å†å¤„ç†
                renderOver = false
                // éšè—å¼¹çª—
                modal.classList.add("hidden");
                //å–æ¶ˆè’™ç‰ˆå¹¶æ¢å¤ç”¨æˆ·å…¶ä»–æ“ä½œ
                enablePage()
            }
        }

        //é¦–å…ˆä¿å­˜ä¸€ä»½æ·±æ‹·è´ï¼Œå…·ä½“åŸå› çœ‹è¿™ä¸ªå…¨å±€å˜é‡è¢«å®šä¹‰çš„åœ°æ–¹
        svgDoc_leave_deepcopy = svgDoc_leave.cloneNode(true)

        showsixOnload(renderRsultData, sucnum)
    }

    //æ–°æ·»åŠ 
    function showsixOnload(data, sucnum) {
        console.log("è¿›å…¥æ–°é˜¶æ®µï¼šå±•ç¤º6ä¸ªæ¸²æŸ“å›¾ç‰‡")
        phase = 6
        checkPhase()
        clearDraw()

        ctx.translate(-PO.x, -PO.y)
        PO = { x: 0, y: 0 };
        ctx.translate(PO.x, PO.y)

        imgH_W = 3752 / 6576
        scaling = canvasH_W / imgH_W

        if (sucnum >= 1) {
            //ç”»img1
            img1.src = data[0].base64;
            img1.onload = function () {
                img1H = canvasH * 170 / 1100
                img1W = canvasH * 170 / 1100
                //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
                ctx.drawImage(img1, canvasW / 1404 * 405 - img1W / 2, canvasH / 3752 * 1140 * scaling - img1H / 2, img1W, img1H);
            }
        }
        if (sucnum >= 2) {
            //ç”»img2
            img2.src = data[1].base64;
            img2.onload = function () {
                //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
                ctx.drawImage(img2, canvasW / 1404 * 565 - img1W / 2, canvasH / 3752 * 1140 * scaling - img1H / 2, img1W, img1H);
            }
        }
        if (sucnum >= 3) {
            //ç”»img3
            img3.src = data[2].base64;
            img3.onload = function () {
                //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
                ctx.drawImage(img3, canvasW / 1404 * 405 - img1W / 2, canvasH / 2.03 - img1H / 2, img1W, img1H);
            }
        }
        if (sucnum >= 4) {
            //ç”»img4
            img4.src = data[3].base64;
            img4.onload = function () {
                //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
                ctx.drawImage(img4, canvasW / 1404 * 565 - img1W / 2, canvasH / 2.03 - img1H / 2, img1W, img1H);
            }
        }
        if (sucnum >= 5) {
            //ç”»img5
            img5.src = data[4].base64;
            img5.onload = function () {
                //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
                ctx.drawImage(img5, canvasW / 1404 * 405 - img1W / 2, canvasH / 2.03 * 2 - canvasH / 3752 * 1140 * scaling - img1H / 2, img1W, img1H);
            }
        }
        if (sucnum >= 6) {
            //ç”»img6
            img6.src = data[5].base64;
            img6.onload = function () {
                //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
                ctx.drawImage(img6, canvasW / 1404 * 565 - img1W / 2, canvasH / 2.03 * 2 - canvasH / 3752 * 1140 * scaling - img1H / 2, img1W, img1H);
            }
        }
        
        //é‡æ–°å®šä¹‰äº‹ä»¶
        //é¼ æ ‡é€‰ä¸­å›¾ç‰‡
        clickImg = function (x, y) {
            //æ‰¾åˆ°å›¾ç‰‡çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œå› ä¸ºç”»å›¾æ˜¯ä»-imgW / 2å¼€å§‹çš„ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯å›¾ç‰‡å æ®çš„ä½ç½®çš„æœ€å°å€¼ï¼Œæœ€å¤§å€¼æ˜¯imgW / 2,yè½´åŒç†
            if (canvasW / 1404 * 405 - img1W / 2 < x && x < canvasW / 1404 * 425 + img1W / 2 && canvasH / 3752 * 1140 * scaling - img1H / 2 < y && y < canvasH / 3752 * 1140 * scaling + img1H / 2 && sucnum >= 1) {
                return 1
            }
            else if (canvasW / 1404 * 565 - img1W / 2 < x && x < canvasW / 1404 * 585 + img1W / 2 && canvasH / 3752 * 1140 * scaling - img1H / 2 < y && y < canvasH / 3752 * 1140 * scaling + img1H / 2 && sucnum >= 2) {
                return 2
            }
            else if (canvasW / 1404 * 405 - img1W / 2 < x && x < canvasW / 1404 * 425 + img1W / 2 && canvasH / 2.03 - img1H / 2 < y && y < canvasH / 2.03 + img1H / 2 && sucnum >= 3) {
                return 3
            }
            else if (canvasW / 1404 * 565 - img1W / 2 < x && x < canvasW / 1404 * 585 + img1W / 2 && canvasH / 2.03 - img1H / 2 < y && y < canvasH / 2.03 + img1H / 2 && sucnum >= 4) {
                return 4
            }
            else if (canvasW / 1404 * 405 - img1W / 2 < x && x < canvasW / 1404 * 425 + img1W / 2 && canvasH / 2.03 * 2 - canvasH / 3752 * 1140 * scaling - img1H / 2 < y && y < canvasH / 2.03 * 2 - canvasH / 3752 * 1140 * scaling + img1H / 2 && sucnum >= 5) {
                return 5
            }
            else if (canvasW / 1404 * 565 - img1W / 2 < x && x < canvasW / 1404 * 585 + img1W / 2 && canvasH / 2.03 * 2 - canvasH / 3752 * 1140 * scaling - img1H / 2 < y && y < canvasH / 2.03 * 2 - canvasH / 3752 * 1140 * scaling + img1H / 2 && sucnum >= 6) {
                return 6
            }
            else {
                return 0
            }
        }
        //æ¸²æŸ“å®Œäº†ï¼Œè¯¥è°ƒç”¨ startTask() æ¥å¼€å§‹å®šæ—¶ä»»åŠ¡é—ªçƒäº†
        startTask()
        //é¼ æ ‡ç‚¹å‡»+é¼ æ ‡ç§»åŠ¨
        canvas.onmousedown = async function (e) {
            //e.offsetXæ˜¯é¼ æ ‡ç‚¹å‡»åˆ°canvasè¾¹çš„ä½ç½®
            lastX = e.offsetX;
            lastY = e.offsetY;
            //é¼ æ ‡ç‚¹å‡»æ—¶çš„ç›¸å¯¹åæ ‡
            var Cp = convertCoordinate(lastX, lastY)

            canMove = clickImg(lastX, lastY)
            canvas.onmouseup = function () {
                if (canMove == 0) {
                    canvas.onmouseup = null;
                }
                else if (1 <= canMove <= 6) {
                    console.log(canMove)
                    //ä¸­æ­¢å®šæ—¶ä»»åŠ¡
                    stopTask()
                    //æ¸…é™¤é¼ æ ‡ç‚¹å‡»äº‹ä»¶
                    canvas.onmousedown = null
                    canvas.onmouseup = null
                    assembleOnload(data[canMove - 1])
                }
            }

        }
    }
</script>

<!-- ç§»åŠ¨éƒ¨åˆ† -->
<script>
    var img0 = new Image();
    //æ–°æ·»åŠ 
    var img1 = new Image();
    var img2 = new Image();
    var img3 = new Image();
    var img4 = new Image();
    var img5 = new Image();
    var img6 = new Image();
    var canMove = true;
    var canScale = true;
    var lastX, lastY;
    var img0H, img0W, initImg0H, initImg0H, img1W, img1H;


    function returnPrevious() {
        console.log("ç‚¹å‡»è¿”å›")
        //æ˜¾ç¤ºâ€œä¸‹è½½â€æŒ‰é’®
        var dwnbtn = document.getElementById('dwnbtn');
        dwnbtn.style.right = canvasW / 10 + 'px';
        dwnbtn.style.bottom = canvasH / 13 + 'px';
        dwnbtn.style.width = canvasW / 11 + 'px';
        dwnbtn.style.height = canvasH / 12 + "px";
        dwnbtn.style.display = "block";
        //æ˜¾ç¤ºâ€œè¿”å›â€æŒ‰é’®
        var returnPreviousCSS = document.getElementById('returnPreviousCSS')
        returnPreviousCSS.style.display = "block";
        //æ–°æ·»åŠ 
        //ä¸æ˜¾ç¤ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
        var reRenderCSS = document.getElementById('reRenderCSS')
        reRenderCSS.style.display = "none";


        svgDoc_leave = svgDoc_leave_deepcopy.cloneNode(true)
        showsixOnload(renderRsultData, renderRsultData.length)
    }


    function assembleOnload(data) {
        console.log("è¿›å…¥ç¬¬å››é˜¶æ®µï¼šç§»åŠ¨")
        phase = 4
        checkPhase()
        clearDraw()

        ctx.translate(-PO.x, -PO.y)
        PO = { x: canvasW / 2, y: canvasH / 2 };
        ctx.translate(PO.x, PO.y)
        //ç”»img
        new Promise((resolve, reject) => {
            //å°†ç”»å¸ƒä¸Šçš„svgå˜æˆé»‘ç¬”ç”»
            var paths = svgDoc_leave.getElementsByTagName("path")
            //æˆ‘å»ï¼ŒchatgptçœŸçš„å¥½ç‰›ï¼Œåˆ é™¤ä¼šæ”¹å˜ä¸‹æ ‡ï¼Œæˆ‘ç›´æ¥ä»åå¾€å‰å°±å¥½äº†
            for (var i = paths.length; i > 0; i--) {
                var strokeHexColor = RGB2Hex(svgDoc_leave.querySelector(".stroke" + i).style.fill)
                if (isColorGrey(strokeHexColor)) {
                    //æœªè¢«é€‰ä¸­ï¼Œåˆ™å˜é»‘
                    svgDoc_leave.querySelector(".stroke" + i).style.fill = 'black'
                }
                else {
                    //å·²è¢«é€‰ä¸­ï¼Œåˆ™åˆ é™¤
                    paths[i - 1].remove();
                }
            }

            //æ¸…ç©ºç”»å¸ƒå¹¶æŠŠæ–°å›¾æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Š
            var modifiedSVG1 = svgDoc_leave.innerHTML
            var blob1 = new Blob([modifiedSVG1], { type: "image/svg+xml" })
            img.src = URL.createObjectURL(blob1);
            img.onload = () => {
                ctx.drawImage(img, -initImgW / 2, -initImgH / 2, initImgW, initImgH)
                resolve()
            };
        })
        console.log("è£…è½½imgå®Œæ¯•ï¼Œå¼€å§‹è£…è½½img0")
        //ç”»img0
        img0.src = data.base64;
        img0.onload = function () {
            img0H = data.height
            img0W = data.width
            initImg0H = img0H
            initImg0W = img0W
            //ç”»å›¾ç‰‡ï¼Œå› ä¸ºåŸç‚¹åœ¨å›¾ç‰‡çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡ç”»å›¾åªéœ€è¦ä»å›¾ç‰‡çš„è´Ÿä¸€åŠåæ ‡å¼€å§‹ç”»ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœ
            ctx.drawImage(img0, -img0W / 2, -img0H / 2, img0W, img0H);

        }

        //å…ˆå®šä¹‰è§¦æ‘¸äº‹ä»¶å•Šï¼ï¼ï¼ï¼
        //è§¦æ‘¸é€‰ä¸­å›¾ç‰‡
        touchImg0 = function (x, y) {
            //æ‰¾åˆ°å›¾ç‰‡çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œå› ä¸ºç”»å›¾æ˜¯ä»-imgW / 2å¼€å§‹çš„ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯å›¾ç‰‡å æ®çš„ä½ç½®çš„æœ€å°å€¼ï¼Œæœ€å¤§å€¼æ˜¯imgW / 2,yè½´åŒç†
            if (-img0W / 2 < x && x < img0W / 2 && -img0H / 2 < y && y < img0H / 2) {
                return true;
            }
            return false
        }

        //è§¦æ‘¸æ‘¸ä¸‹+è§¦æ‘¸ç§»åŠ¨+åŒæ‰‹æ”¾ç¼©
        canvas.ontouchstart = function (e) {
            e.preventDefault();
            if (e.touches.length === 2) {
                console.log("æ˜¯åŒæ‰‹è§¦æ‘¸äº‹ä»¶")

                // å¦‚æœç”¨æˆ·ä½¿ç”¨ä¸¤ä¸ªæ‰‹æŒ‡è§¦æ‘¸å±å¹•ï¼Œåˆ™è®°å½•ç¼©æ”¾çš„èµ·ç‚¹ä½ç½®å’Œç¼©æ”¾èµ·å§‹è·ç¦»
                const touch1 = e.touches[0]
                const touch2 = e.touches[1];
                lastX = (touch1.clientX + touch2.clientX) / 2;
                lastY = (touch1.clientY + touch2.clientY) / 2;
                lastDoubleTouchDistance = Math.sqrt(
                    Math.pow(touch1.clientX - touch2.clientX, 2) + Math.pow(touch1.clientY - touch2.clientY, 2)
                );
                lastDoubleTouchScale = scale;
            }
            else {
                // console.log("è§¦æ‘¸äº‹ä»¶",e)
                var touch = e.changedTouches[0];
                lastX = touch.clientX;
                lastY = touch.clientY;
                var Cp = convertCoordinate(lastX, lastY)
                canMove = touchImg0(Cp.x, Cp.y)
            }

            // å¦‚æœæ­£åœ¨æ‹–æ‹½
            canvas.ontouchmove = function (moveEvent) {
                if (moveEvent.touches.length === 2) {
                    // å¦‚æœç”¨æˆ·ä½¿ç”¨ä¸¤ä¸ªæ‰‹æŒ‡è§¦æ‘¸å±å¹•ï¼Œåˆ™è®¡ç®—è·ç¦»æ¯”ä¾‹å¹¶ç¼©æ”¾å›¾ç‰‡
                    const curtouch1 = moveEvent.touches[0];
                    const curtouch2 = moveEvent.touches[1];
                    const distance = Math.sqrt(
                        Math.pow(curtouch1.clientX - curtouch2.clientX, 2) + Math.pow(curtouch1.clientY - curtouch2.clientY, 2)
                    );

                    // è·å–ç”»å¸ƒçš„è¾¹ç•Œ
                    var canvasRect = canvas.getBoundingClientRect();
                    var canvasLeft = canvasRect.left;
                    var canvasTop = canvasRect.top;
                    var canvasWidth = canvasRect.width;
                    var canvasHeight = canvasRect.height;

                    // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨ç”»å¸ƒä¸Š
                    if (!((curtouch1.clientX > canvasLeft && curtouch1.clientX < canvasLeft + canvasWidth &&
                        curtouch1.clientY > canvasTop && curtouch1.clientY < canvasTop + canvasHeight)
                        &&
                        (curtouch2.clientX > canvasLeft && curtouch2.clientX < canvasLeft + canvasWidth &&
                            curtouch2.clientY > canvasTop && curtouch2.clientY < canvasTop + canvasHeight)
                    )) {
                        canMove = false   //ä¸åœ¨ç”»å¸ƒä¸Šéœ€å–æ¶ˆ
                        canScale = false;
                    }
                    else {
                        canMove = true
                        canScale = true
                    }


                    if (canScale) {


                        if (initImg0H * lastDoubleTouchScale * distance / lastDoubleTouchDistance < canvasH * 2 / 3
                            &&
                            initImg0W * lastDoubleTouchScale * distance / lastDoubleTouchDistance > 100) {
                            scale = lastDoubleTouchScale * distance / lastDoubleTouchDistance
                        }
                        img0W = scale * initImg0W;
                        img0H = scale * initImg0H;


                        // è®¡ç®—ç§»åŠ¨è·ç¦»
                        var deltaX = (curtouch1.clientX + curtouch2.clientX) / 2 - lastX;
                        var deltaY = (curtouch1.clientY + curtouch2.clientY) / 2 - lastY;

                        //æ ¹æ®ç§»åŠ¨é‡æ–°è§„åˆ’é›¶ç‚¹
                        PO = { x: deltaX + PO.x, y: deltaY + PO.y };
                        //æ›´æ–°åŸç‚¹ä½ç½®
                        ctx.translate(deltaX, deltaY)
                        drawImg0()
                        lastX = (curtouch1.clientX + curtouch2.clientX) / 2;
                        lastY = (curtouch1.clientY + curtouch2.clientY) / 2;
                    }
                }
                else {
                    var moveTouch = moveEvent.changedTouches[0]
                    var currentX = moveTouch.clientX;
                    var currentY = moveTouch.clientY;

                    // è·å–ç”»å¸ƒçš„è¾¹ç•Œ
                    var canvasRect = canvas.getBoundingClientRect();
                    var canvasLeft = canvasRect.left;
                    var canvasTop = canvasRect.top;
                    var canvasWidth = canvasRect.width;
                    var canvasHeight = canvasRect.height;
                    // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨ç”»å¸ƒä¸Š
                    if (!(currentX > canvasLeft && currentX < canvasLeft + canvasWidth &&
                        currentY > canvasTop && currentY < canvasTop + canvasHeight)) {
                        canMove = false   //ä¸åœ¨ç”»å¸ƒä¸Šéœ€å–æ¶ˆ
                        canScale = false;
                    }

                    if (canMove) {
                        // console.log("è§¦æ‘¸åœ¨äº†å›¾ç‰‡ä¸Šï¼Œå¹¶æ­£åœ¨ç§»åŠ¨",moveEvent)
                        // è®¡ç®—ç§»åŠ¨è·ç¦»
                        var deltaX = moveTouch.clientX - lastX;
                        var deltaY = moveTouch.clientY - lastY;

                        //æ ¹æ®ç§»åŠ¨é‡æ–°è§„åˆ’é›¶ç‚¹
                        PO = { x: deltaX + PO.x, y: deltaY + PO.y };
                        ctx.translate(deltaX, deltaY)
                        drawImg0()
                        lastX = currentX;  //ä¿å­˜èµ·æ¥è¿™æ¬¡å›¾ç”»åˆ°äº†å“ªé‡Œ
                        lastY = currentY;
                    }
                }
            }

            canvas.ontouchcancel = function (e) {
                console.log("å–æ¶ˆäº†")
                canvas.ontouchmove = null;
                document.ontouchend = null;
                canMove = false;
                canScale = false;
            }

            document.ontouchend = function () {
                console.log("ç¦»å¼€äº†")
                canvas.ontouchmove = null;
                document.ontouchend = null;
                canMove = false;
                canScale = false;
            }
        }


        //å†å®šä¹‰é¼ æ ‡ç‚¹å‡»äº‹ä»¶å•Šï¼ï¼ï¼
        //é¼ æ ‡é€‰ä¸­å›¾ç‰‡
        clickImg0 = function (x, y) {
            //æ‰¾åˆ°å›¾ç‰‡çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œå› ä¸ºç”»å›¾æ˜¯ä»-imgW / 2å¼€å§‹çš„ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯å›¾ç‰‡å æ®çš„ä½ç½®çš„æœ€å°å€¼ï¼Œæœ€å¤§å€¼æ˜¯imgW / 2,yè½´åŒç†
            if (-img0W / 2 < x && x < img0W / 2 && -img0H / 2 < y && y < img0H / 2) {
                return true;
            }
            return false
        }
        
        //é¼ æ ‡ç‚¹å‡»+é¼ æ ‡ç§»åŠ¨
        canvas.onmousedown = async function (e) {
            //e.offsetXæ˜¯é¼ æ ‡ç‚¹å‡»åˆ°canvasè¾¹çš„ä½ç½®
            lastX = e.offsetX;
            lastY = e.offsetY;
            //é¼ æ ‡ç‚¹å‡»æ—¶çš„ç›¸å¯¹åæ ‡
            var Cp = convertCoordinate(lastX, lastY)
            canMove = clickImg0(Cp.x, Cp.y)

            //å°†å›¾ç‰‡è¾¹ç¼˜æé»‘
            canvas.onmousemove = function (e) {
                // console.log("é¼ æ ‡ç§»åŠ¨")
                var x = e.offsetX;
                var y = e.offsetY;

                if (canMove) {
                    //ç®—å‡ºæ¥ç§»åŠ¨çš„åƒç´ ï¼ˆæ¯æ¬¡éƒ½æ˜¯å‡å»ä¸Šæ¬¡çš„å€¼ï¼‰
                    var Mx = x - lastX;
                    var My = y - lastY;
                    //æ ¹æ®ç§»åŠ¨é‡æ–°è§„åˆ’é›¶ç‚¹
                    PO = { x: Mx + PO.x, y: My + PO.y };
                    ctx.translate(Mx, My)
                    drawImg0(PO)
                    lastX = x;  //ä¿å­˜èµ·æ¥è¿™æ¬¡å›¾ç”»åˆ°äº†å“ªé‡Œ
                    lastY = y;
                }

                document.onmouseup = function () {
                    canvas.onmousemove = null;
                    document.onmouseup = null;
                    canMove = false
                }
            }
        }
        
        //é¼ æ ‡æ»šè½®
        canvas.onmousewheel = function (e) {
            // console.log("é¼ æ ‡æ»šè½®",e)
            var x = e.offsetX;
            var y = e.offsetY;
            var Cp = convertCoordinate(x, y)
            canScale = clickImg0(Cp.x, Cp.y)
            //åŒæ ·éœ€è¦åˆ¤æ–­å¦‚æœé¼ æ ‡åœ¨å›¾ç‰‡ä¸Šï¼Œæ‰å…è®¸ç¼©æ”¾
            if (canScale) {
                //e.wheelDeltaå¦‚æœå¤§äº0ï¼Œè¯æ˜é¼ æ ‡æ˜¯å‘ä¸Šæ»šåŠ¨ï¼Œåä¹‹å‘ä¸‹
                //ä½¿ç”¨*=é”™è¯¯çš„ï¼Œå› ä¸ºä½ è¦æ˜¯1.04->1.02ï¼Œè™½ç„¶æ˜¯å°ï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨å¢å¤§!æ‰€ä»¥è¦ç”¨initImgWå›ºå®šå€¼ï¼
                if (img0H < canvasH * 2 / 3 && e.wheelDelta > 0) {
                    //æ”¾å¤§çš„å€æ•°å¯ä»¥æ ¹æ®å®é™…æƒ…å†µå®šä¹‰ï¼Œå¯ä»¥ä¸æ»‘ä¸€ç‚¹
                    scale += 0.02
                }
                if (img0W > 100 && e.wheelDelta < 0) {
                    scale -= 0.02
                }
                img0W = scale * initImg0W;
                img0H = scale * initImg0H;
                drawImg0()
            }
        }
        
                    
        function drawImg0() {
            ctx.clearRect(-canvas.width, -canvas.height, canvas.width * 2, canvas.height * 2);
            //æŒ‡å®šä¸­å¿ƒä¸ºç”»å¸ƒæ­£ä¸­å¤®
            ctx.translate(-PO.x, -PO.y);
            ctx.translate(canvasW / 2, canvasH / 2)
            ctx.drawImage(img, -initImgW / 2, -initImgH / 2, initImgW, initImgH)
            ctx.translate(-canvasW / 2, -canvasH / 2)
            ctx.translate(PO.x, PO.y);
            ctx.drawImage(img0, -img0W / 2, -img0H / 2, img0W, img0H);
        }
    }
</script>

<!-- ä¿å­˜éƒ¨åˆ† -->
<script>
    function download() {
        console.log("è¿›å…¥ç¬¬äº”é˜¶æ®µï¼šä¿å­˜")
        phase = 5
        checkPhase()

        QRcode()
    }

    //ç‚¹å‡»â€œé‡æ–°è¾“å…¥æ ‡ç­¾â€
    function backInput() {
        console.log("ç‚¹å‡»é‡æ–°è¾“å…¥æ ‡ç­¾")
        //ä¸æ˜¾ç¤ºâ€œä¸‹è½½â€æŒ‰é’®
        var dwnbtn = document.getElementById('dwnbtn')
        dwnbtn.style.display = "none"
        //ä¸æ˜¾ç¤ºâ€œé¦–é¡µâ€æŒ‰é’®
        var returnHomeCSS = document.getElementById('returnHomeCSS')
        returnHomeCSS.style.display = "none"
        //ä¸æ˜¾ç¤ºâ€œé‡æ–°è¾“å…¥æ ‡ç­¾â€æŒ‰é’®
        var backInputCSS = document.getElementById('backInputCSS')
        backInputCSS.style.display = "none";
        //ä¸æ˜¾ç¤ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
        var reRenderCSS = document.getElementById('reRenderCSS')
        reRenderCSS.style.display = "none";
        //ä¸æ˜¾ç¤ºäºŒç»´ç 
        var qr = document.getElementById("qrcode")
        qr.style.display = "none";
        qr.innerHTML = '' //æ¸…ç©º
        phase = 3

        //æœ‰â€œå±•ç¤º6å¼ å›¾ç‰‡æ—¶è¿”å›â€å’Œâ€œæœ€åä¸€é¡µè¿”å›â€ä¸¤ç§æƒ…æ™¯
        //éœ€è¦åšäº›å¤„ç†â€”â€”â€”â€”

        //1.ä¸­æ­¢å®šæ—¶ä»»åŠ¡
        stopTask()
        //2.å¤åŸæ˜¾ç¤ºsvgDoc_leave
        console.log(svgDoc_leave_deepcopy)
        svgDoc_leave = svgDoc_leave_deepcopy.cloneNode(true)
        // å¦‚æœè¿æ°”ä¸å¥½ï¼Œåˆšå¥½è¢«ç‚¹æ‰äº†ï¼Œæˆ‘æŠŠå®ƒå¤åŸå›æ¥
        var paths = svgDoc_leave.getElementsByTagName("path")
        //å¯¹svgDoc_leaveè®¾ç½®å¯ä¸å¯è§
        for (var i = 1; i <= paths.length; i++) {
            var element = svgDoc_leave.querySelector(".stroke" + i)
            if (!isColorGrey(RGB2Hex(element.style.fill))) {
                //è‹¥è¢«é€‰ä¸­çš„ç¬”ç”»å¯è§ï¼Œåˆ™è®¾ç½®ä¸å¯è§ï¼›åä¹‹è®¾ç½®ä¸ºå¯è§ï¼Œä»¥å®ç°é—ªçƒçš„æ•ˆæœ
                if (element.style.display == 'none') {
                    element.style.display = 'block'
                }
            }
        }

        slectedOver()
    }

    function reRender() {
        console.log("ç‚¹å‡»é‡æ–°ç”Ÿæˆ")
        //ä¸æ˜¾ç¤ºâ€œä¸‹è½½â€æŒ‰é’®
        var dwnbtn = document.getElementById('dwnbtn')
        dwnbtn.style.display = "none"
        //ä¸æ˜¾ç¤ºâ€œé‡æ–°è¾“å…¥æ ‡ç­¾â€æŒ‰é’®
        var backInputCSS = document.getElementById('backInputCSS')
        backInputCSS.style.display = "none";
        //ä¸æ˜¾ç¤ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
        var reRenderCSS = document.getElementById('reRenderCSS')
        reRenderCSS.style.display = "none";

        phase = 3
        //1.ä¸­æ­¢å®šæ—¶ä»»åŠ¡
        stopTask()
        //2.é‡æ–°æ¸²æŸ“
        console.log("è€çš„")
        console.log(oldInputEng)
        console.log(oldBase64)
        render(oldInputEng, oldBase64)
    }

    async function QRcode() {
        console.log("æ­£åœ¨ç”ŸæˆäºŒç»´ç äº†")
        final()
        console.log("å·²å°†ä¸€åˆ‡ç½®ç©º")

        // å°†å›¾ç‰‡è½¬æ¢ä¸º Base64 ç¼–ç 
        var canvasBase64 = canvas.toDataURL('image/png');
        var base64Image = ''
        var saveImg = new Image();
        // å°† SVG è½¬æ¢ä¸ºå›¾ç‰‡
        saveImg.src = canvasBase64
        // å½“ SVG è½¬åŒ–ä¸ºå›¾ç‰‡æ—¶è§¦å‘
        await new Promise(resolve => {
            saveImg.onload = function () {
                // åˆ›å»ºä¸€ä¸ª Canvas å…ƒç´ 
                var canvas2 = document.createElement('canvas');
                canvas2.width = saveImg.width;
                canvas2.height = saveImg.height;

                // Canvas2æ‰“ä¸Šç™½åº•å†ç”»ä¸ŠsaveImg
                var ctx2 = canvas2.getContext('2d');
                ctx2.fillStyle = "white"
                ctx2.fillRect(0, 0, canvasW, canvasH);//å¡«å……ç”»çŸ©å½¢
                ctx2.drawImage(saveImg, 0, 0);
                // å°† Canvas è½¬æ¢ä¸º base64 ç¼–ç çš„å›¾ç‰‡
                base64Image = canvas2.toDataURL();
                resolve()
            };
        })

        //ä¸Šä¼ é˜¿é‡Œäº‘
        var url = ''
        await axios({
            method: 'POST',
            url: '/upload',
            data: {
                "data": base64Image,
            }
        })
            .then(res => {
                console.log("ä¸Šä¼ æˆåŠŸ", res)
                url = res.data.urls
            })
            .catch(error => {
                console.log('ä¸Šä¼ å‡ºç°é”™è¯¯', error.message)
            })

        // å°† Base64 ç¼–ç ç”ŸæˆäºŒç»´ç 
        const qr = document.getElementById("qrcode")
        console.log("æ£€æŸ¥å½“å‰url", url)
        var qrcode = new QRCode(qr, {
            text: url,
            width: canvasH / 4,
            height: canvasH / 4,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        qr.style.display = "block";
    }

    //æœ€åçš„æœ€åï¼Œä¸€åˆ‡ç½®ç©º
    function final() {
        //å°†å„ç§äº‹ä»¶ç½®ç©º
        canvas.ontouchcancel = null
        canvas.ontouchstart = null
        canvas.ontouchend = null
        canvas.ontouchmove = null
        canvas.onmousedown = null
        canvas.onmouseleave = null
        canvas.onmouseup = null
        canvas.onmousemove = null
        canvas.onmousewheel = null
        canvas.onmouseover = null

        //å°†å›é€€æŒ‰é’®æ˜¾ç°
        const returnHomeCSS = document.getElementById("returnHomeCSS")
        returnHomeCSS.style.display = "block";
        var backInputCSS = document.getElementById('backInputCSS')
        backInputCSS.style.left = "180px";
        backInputCSS.style.display = "block";
    }

    function returnHome() {
        console.log("é‡å›ä¸»é¡µ")
        //ä¸æ˜¾ç¤ºâ€œé¦–é¡µâ€æŒ‰é’®
        var returnHomeCSS = document.getElementById('returnHomeCSS')
        returnHomeCSS.style.display = "none"
        //ä¸æ˜¾ç¤ºâ€œé‡æ–°è¾“å…¥æ ‡ç­¾â€æŒ‰é’®
        var backInputCSS = document.getElementById('backInputCSS')
        backInputCSS.style.display = "none";
        //ä¸æ˜¾ç¤ºäºŒç»´ç 
        var qr = document.getElementById("qrcode")
        qr.style.display = "none";
        qr.innerHTML = '' //æ¸…ç©º

        var clickFunction = function () {
            window.onload()
            //æ‰§è¡Œå®Œæ¯•ä¹‹åè‡ªåŠ¨åˆ é™¤è‡ªå·±ï¼Œé¿å…å‡ºbug
            document.removeEventListener('click', clickFunction)
        }
        document.addEventListener('click', clickFunction)
    }
</script>